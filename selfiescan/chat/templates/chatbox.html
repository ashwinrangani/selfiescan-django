{% extends "base.html" %}
{% load static %}
{% block title %}Ask AI{% endblock %}
{% block content %}
<section class="max-w-xl mx-auto mt-12">
    <h1 class="text-3xl font-bold mb-6 text-gray-800">ðŸ’¬ Chat with our AI Assistant</h1>

    <div id="chat-log" class="border rounded-lg p-4 h-96 overflow-y-auto bg-gray-50 space-y-3 shadow-inner scroll-smooth relative bg-gray-100 space-y-4 shadow-lg box-sizing-border-box">
        <!-- Messages will be appended here -->
    </div>

    <div class="flex mt-4 gap-2">
        <input id="chat-message-input" type="text" 
               class="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200 bg-white" 
               placeholder="Type your message...">
        <button id="chat-message-submit" class="btn btn-primary px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 transition duration-200">Send</button>
    </div>
</section>

<style>
    .message-bubble {
        max-width: 70%;
        word-wrap: break-word;
        animation: fadeIn 0.3s ease-in;
    }
    .user-message {
        background-color: #3b82f6; /* Blue-500 */
        color: white;
    }
    .ai-message {
        background-color: #ffffff;
        color: #1f2937; /* Gray-800 */
    }
    .loading-message {
        background-color: #f3f4f6; /* Gray-100 */
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .scroll-smooth {
        scroll-behavior: smooth;
    }
    #chat-log {
        box-sizing: border-box; /* Ensure padding is included in dimensions */
    }
</style>

<script>
    const chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chat/');
    const chatLog = document.getElementById('chat-log');
    const messageInput = document.getElementById('chat-message-input');
    const sendButton = document.getElementById('chat-message-submit');
    let loadingMessage = null;

    chatSocket.onmessage = function(e) {
        if (loadingMessage) {
            loadingMessage.remove(); // Remove loading indicator
            loadingMessage = null;
        }
        const data = JSON.parse(e.data);
        appendMessage('ðŸ¤–', data.message, true);
    };

    chatSocket.onopen = () => console.log('WebSocket connected.');
    chatSocket.onclose = () => console.error('WebSocket disconnected.');

    sendButton.onclick = sendMessage;
    messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') sendMessage();
    });

    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        appendMessage('ðŸ§‘', message, false);
        appendLoading();
        chatSocket.send(JSON.stringify({'message': message}));
        messageInput.value = '';
    }

    function appendMessage(sender, message, isAi) {
        const messageEl = document.createElement('div');
        messageEl.className = `flex ${isAi ? 'justify-start' : 'justify-end'} items-start mb-2`;
        
        const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        messageEl.innerHTML = `
            <div class="flex items-center gap-2">
                ${isAi ? `<span class="text-2xl">${sender}</span>` : ''}
                <div class="message-bubble px-4 py-2 rounded-lg shadow ${isAi ? 'ai-message' : 'user-message'}">
                    <p>${escapeHtml(message)}</p>
                    <span class="text-xs text-gray-500">${timestamp}</span>
                </div>
                ${isAi ? '' : `<span class="text-2xl">${sender}</span>`}
            </div>
        `;
        chatLog.appendChild(messageEl);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function appendLoading() {
        loadingMessage = document.createElement('div');
        loadingMessage.className = 'flex justify-start items-start mb-2';
        loadingMessage.innerHTML = `
            <div class="flex items-center gap-2">
                <span class="text-2xl">ðŸ¤–</span>
                <div class="message-bubble loading-message px-4 py-2 rounded-lg shadow">
                    <span class="loading loading-dots loading-lg"></span>
                </div>
            </div>
        `;
        chatLog.appendChild(loadingMessage);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}
